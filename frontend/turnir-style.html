<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Турнирная сетка - Стиль Turnir-Online</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            background-color: #ffffff;
        }
        
        .tournament-info {
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #000;
            padding: 10px;
        }
        
        .tournament-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .controls {
            margin: 10px 0;
            text-align: center;
        }
        
        .btn {
            background: #f0f0f0;
            border: 1px solid #999;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .btn:hover {
            background: #e0e0e0;
        }
        
        .bracket-container {
            overflow-x: auto;
            margin: 0 auto;
            padding: 10px;
        }
        
        .bracket-grid {
            display: table;
            border-collapse: collapse;
            margin: 0 auto;
            border: 1px solid #000;
            white-space: nowrap;
        }
        
        .bracket-column {
            display: table-cell;
            vertical-align: top;
            border-right: 1px solid #000;
            padding: 5px;
            min-width: 120px;
        }
        
        .bracket-column:last-child {
            border-right: none;
        }
        
        .round-header {
            background: #E6E6FA;
            font-weight: bold;
            padding: 5px;
            text-align: center;
            border: 1px solid #000;
            margin-bottom: 5px;
        }
        
        .match-cell {
            border: 1px solid #000;
            padding: 2px;
            margin-bottom: 10px;
            position: relative;
            background: white;
            min-height: 50px;
        }
        
        .match-number {
            font-size: 10px;
            color: #666;
            position: absolute;
            top: 1px;
            left: 2px;
        }
        
        .team-slot {
            display: block;
            padding: 1px 3px;
            margin: 1px 0;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            font-size: 11px;
            min-height: 12px;
        }
        
        .team-slot:hover {
            background: #f0f8ff;
        }
        
        .team-slot.winner {
            background: #90EE90;
            font-weight: bold;
        }
        
        .team-slot.loser {
            background: #FFB6C1;
            text-decoration: line-through;
            color: #666;
        }
        
        .bye-slot {
            background: #FFFACD;
            font-style: italic;
            color: #888;
        }
        

        
        .winners-bracket {
            margin-bottom: 20px;
        }
        
        .losers-bracket {
            margin-bottom: 20px;
        }
        
        .final-bracket {
            margin-top: 20px;
        }
        
        .champion {
            background: #FFD700 !important;
            font-weight: bold;
            font-size: 14px;
            padding: 10px;
            text-align: center;
            border: 2px solid #FFA500;
        }
        
        .bracket-label {
            font-weight: bold;
            text-align: center;
            margin: 10px 0 5px 0;
            padding: 5px;
            background: #f0f0f0;
            border: 1px solid #999;
        }
        
        .connector-line {
            width: 20px;
            height: 1px;
            background: #000;
            margin: 0 auto;
        }
        
        .status-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f0f0f0;
            border: 1px solid #999;
            padding: 5px;
            font-size: 10px;
            max-width: 200px;
        }
        
        .participants-count {
            text-align: right;
            font-size: 11px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="tournament-info">
        <div class="tournament-title">Турнирная сетка "Double Elimination" (до двух поражений)</div>
        <div>Система на выбывание с сеткой проигравших</div>
    </div>
    
    <div class="participants-count" id="participants-info">
        Участники: <span id="team-count">0</span>
    </div>
    
    <div class="controls">
        <button class="btn" onclick="createTournament(4)">4 команды</button>
        <button class="btn" onclick="createTournament(8)">8 команд</button>
        <button class="btn" onclick="createTournament(16)">16 команд</button>
        <button class="btn" onclick="simulateMatch()">Случайный результат</button>
        <button class="btn" onclick="resetTournament()">Сброс</button>
        <button class="btn" onclick="hideControls()">Скрыть управление</button>
    </div>
    
    <div id="bracket-container">
        <p style="text-align: center; color: #666; font-style: italic;">Выберите количество команд для начала турнира</p>
    </div>
    
    <div class="status-info" id="status">
        <strong>Статус:</strong><br>
        Готов к созданию турнира
    </div>
    
    <script>
        let tournament = {
            teams: [],
            matches: [],
            currentMatchId: 1,
            isComplete: false,
            champion: null
        };
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = `<strong>Статус:</strong><br>${message}`;
        }
        
        function generateTeams(count) {
            const names = [
                'Команда A', 'Команда B', 'Команда C', 'Команда D',
                'Команда E', 'Команда F', 'Команда G', 'Команда H',
                'Команда I', 'Команда J', 'Команда K', 'Команда L',
                'Команда M', 'Команда N', 'Команда O', 'Команда P'
            ];
            
            return Array.from({length: count}, (_, i) => ({
                id: i + 1,
                name: names[i] || `Команда ${i + 1}`,
                eliminated: false,
                losses: 0,
                seed: i + 1
            }));
        }
        
        function createTournament(teamCount) {
            tournament.teams = generateTeams(teamCount);
            tournament.matches = [];
            tournament.currentMatchId = 1;
            tournament.isComplete = false;
            tournament.champion = null;
            
            document.getElementById('team-count').textContent = teamCount;
            
            generateFullTournamentStructure();
            renderBracket();
            updateStatus(`Турнир создан: ${teamCount} команд. Вся структура готова. Начинайте матчи.`);
        }
        
        function generateBracketStructure() {
            tournament.matches = [];
            tournament.currentMatchId = 1;
            
            // Генерируем полную структуру турнира заранее
            generateFullTournamentStructure();
        }
        
        function generateFullTournamentStructure() {
            const teamCount = tournament.teams.length;
            const winnersRounds = Math.ceil(Math.log2(teamCount));
            const losersRounds = winnersRounds * 2 - 1;
            
            // Создаем Winners Bracket
            generateWinnersBracketStructure(winnersRounds);
            
            // Создаем Losers Bracket
            generateLosersBracketStructure(losersRounds);
            
            // Заполняем первый раунд Winners Bracket командами
            fillFirstRound();
        }
        
        function generateWinnersBracketStructure(rounds) {
            let matchesInRound = Math.ceil(tournament.teams.length / 2);
            
            for (let round = 1; round <= rounds; round++) {
                for (let pos = 0; pos < matchesInRound; pos++) {
                    const match = {
                        id: tournament.currentMatchId++,
                        team1: null,
                        team2: null,
                        winner: null,
                        loser: null,
                        bracket: 'winners',
                        round: round,
                        status: 'waiting',
                        position: pos
                    };
                    tournament.matches.push(match);
                }
                matchesInRound = Math.ceil(matchesInRound / 2);
            }
        }
        
        function generateLosersBracketStructure(rounds) {
            for (let round = 1; round <= rounds; round++) {
                let matchesInRound;
                if (round === 1) {
                    matchesInRound = Math.floor(tournament.teams.length / 4);
                } else if (round % 2 === 0) {
                    // Четные раунды - меньше матчей
                    matchesInRound = Math.ceil(tournament.teams.length / Math.pow(2, round + 1));
                } else {
                    // Нечетные раунды - больше матчей
                    matchesInRound = Math.ceil(tournament.teams.length / Math.pow(2, round));
                }
                
                if (matchesInRound < 1) matchesInRound = 1;
                
                for (let pos = 0; pos < matchesInRound; pos++) {
                    const match = {
                        id: tournament.currentMatchId++,
                        team1: null,
                        team2: null,
                        winner: null,
                        loser: null,
                        bracket: 'losers',
                        round: round,
                        status: 'waiting',
                        position: pos
                    };
                    tournament.matches.push(match);
                }
            }
        }
        
        function fillFirstRound() {
            const firstRoundMatches = tournament.matches.filter(m => 
                m.bracket === 'winners' && m.round === 1
            ).sort((a, b) => a.position - b.position);
            
            for (let i = 0; i < tournament.teams.length; i += 2) {
                const matchIndex = Math.floor(i / 2);
                if (matchIndex < firstRoundMatches.length) {
                    const match = firstRoundMatches[matchIndex];
                    match.team1 = tournament.teams[i];
                    match.team2 = tournament.teams[i + 1] || null;
                    
                    if (match.team2) {
                        match.status = 'ready';
                    } else {
                        match.status = 'bye';
                        match.winner = match.team1;
                    }
                }
            }
        }
        
        function generateWinnersBracketRounds() {
            let currentRound = 1;
            let currentMatches = tournament.matches.filter(m => m.bracket === 'winners' && m.round === 1);
            
            while (currentMatches.length > 1) {
                currentRound++;
                const nextRoundMatches = [];
                
                for (let i = 0; i < currentMatches.length; i += 2) {
                    const match1 = currentMatches[i];
                    const match2 = currentMatches[i + 1];
                    
                    if (match2) {
                        const nextMatch = {
                            id: tournament.currentMatchId++,
                            team1: null,
                            team2: null,
                            winner: null,
                            loser: null,
                            bracket: 'winners',
                            round: currentRound,
                            status: 'waiting',
                            position: Math.floor(i / 2),
                            sourceMatches: [match1.id, match2.id]
                        };
                        
                        tournament.matches.push(nextMatch);
                        nextRoundMatches.push(nextMatch);
                        
                        match1.nextMatch = nextMatch.id;
                        match2.nextMatch = nextMatch.id;
                    } else {
                        nextRoundMatches.push(match1);
                    }
                }
                
                currentMatches = nextRoundMatches;
            }
        }
        
        function renderBracket() {
            const container = document.getElementById('bracket-container');
            
            // Группируем матчи по bracket и round
            const winnerRounds = {};
            const loserRounds = {};
            
            tournament.matches.forEach(match => {
                if (match.bracket === 'winners') {
                    if (!winnerRounds[match.round]) winnerRounds[match.round] = [];
                    winnerRounds[match.round].push(match);
                } else if (match.bracket === 'losers') {
                    if (!loserRounds[match.round]) loserRounds[match.round] = [];
                    loserRounds[match.round].push(match);
                }
            });
            
            let html = '';
            
            // Создаем горизонтальное расположение: Losers слева, Winners справа
            html += '<div style="display: flex; gap: 20px; justify-content: center;">';
            
            // Losers Bracket слева
            if (Object.keys(loserRounds).length > 0) {
                html += '<div style="flex: 1;">';
                html += '<div class="bracket-label">Losers Bracket</div>';
                html += '<div class="losers-bracket">';
                html += renderBracketGrid(loserRounds, 'L');
                html += '</div>';
                html += '</div>';
            }
            
            // Winners Bracket справа
            if (Object.keys(winnerRounds).length > 0) {
                html += '<div style="flex: 1;">';
                html += '<div class="bracket-label">Winners Bracket</div>';
                html += '<div class="winners-bracket">';
                html += renderBracketGrid(winnerRounds, 'W');
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            // Финал
            if (tournament.champion) {
                html += '<div class="bracket-label">🏆 Чемпион турнира 🏆</div>';
                html += '<div class="final-bracket">';
                html += `<div class="champion">${tournament.champion.name}</div>`;
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function renderBracketGrid(rounds, prefix) {
            const roundNumbers = Object.keys(rounds).map(Number).sort((a, b) => a - b);
            
            let html = '<div class="bracket-container">';
            html += '<div class="bracket-grid">';
            
            // Создаем колонки для каждого раунда
            roundNumbers.forEach((round, roundIndex) => {
                const matches = rounds[round] || [];
                
                html += '<div class="bracket-column">';
                html += `<div class="round-header">${prefix}${round}</div>`;
                
                matches.forEach(match => {
                    html += '<div class="match-cell">';
                    html += renderMatch(match);
                    html += '</div>';
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            html += '</div>';
            return html;
        }
        
        function renderMatch(match) {
            let html = `<div class="match-number">${match.id}</div>`;
            
            if (match.status === 'bye') {
                html += `<div class="team-slot bye-slot">BYE</div>`;
                html += `<div class="team-slot winner">${match.team1.name}</div>`;
                return html;
            }
            
            if (match.team1) {
                const team1Class = match.winner && match.winner.id === match.team1.id ? 'winner' : 
                                 match.loser && match.loser.id === match.team1.id ? 'loser' : '';
                html += `<div class="team-slot ${team1Class}" onclick="setWinner(${match.id}, ${match.team1.id})">${match.team1.name}</div>`;
            } else {
                html += '<div class="team-slot" style="color: #ccc;">Ожидание</div>';
            }
            
            if (match.team2) {
                const team2Class = match.winner && match.winner.id === match.team2.id ? 'winner' : 
                                 match.loser && match.loser.id === match.team2.id ? 'loser' : '';
                html += `<div class="team-slot ${team2Class}" onclick="setWinner(${match.id}, ${match.team2.id})">${match.team2.name}</div>`;
            } else if (match.status !== 'bye') {
                html += '<div class="team-slot" style="color: #ccc;">Ожидание</div>';
            }
            
            return html;
        }
        
        function setWinner(matchId, winnerId) {
            const match = tournament.matches.find(m => m.id === matchId);
            if (!match || match.winner || (match.status !== 'ready' && match.status !== 'bye')) return;
            
            const winner = tournament.teams.find(t => t.id === winnerId);
            const loser = match.team1 && match.team1.id === winnerId ? match.team2 : match.team1;
            
            match.winner = winner;
            match.loser = loser;
            match.status = 'completed';
            
            // Увеличиваем поражения
            if (loser) {
                loser.losses++;
                if (loser.losses >= 2) {
                    loser.eliminated = true;
                }
            }
            
            // Продвигаем победителя в Winners Bracket
            if (match.bracket === 'winners') {
                advanceWinnerInWinnersBracket(winner, match.round, match.position);
                
                // Отправляем проигравшего в Losers Bracket
                if (loser && loser.losses === 1) {
                    sendToLosersBracket(loser, match.round);
                }
            }
            
            // Продвигаем победителя в Losers Bracket
            if (match.bracket === 'losers') {
                advanceWinnerInLosersBracket(winner, match.round, match.position);
            }
            
            checkTournamentComplete();
            renderBracket();
            updateStatus(`Матч ${matchId}: ${winner.name} победил`);
        }
        
        function advanceWinnerInWinnersBracket(winner, currentRound, currentPosition) {
            const nextRound = currentRound + 1;
            const nextPosition = Math.floor(currentPosition / 2);
            
            const nextMatch = tournament.matches.find(m => 
                m.bracket === 'winners' && 
                m.round === nextRound && 
                m.position === nextPosition
            );
            
            if (nextMatch) {
                if (!nextMatch.team1) {
                    nextMatch.team1 = winner;
                } else if (!nextMatch.team2) {
                    nextMatch.team2 = winner;
                    nextMatch.status = 'ready';
                }
            }
        }
        
        function advanceWinnerInLosersBracket(winner, currentRound, currentPosition) {
            const nextRound = currentRound + 1;
            const maxLosersRounds = Math.ceil(Math.log2(tournament.teams.length)) * 2 - 1;
            
            if (nextRound <= maxLosersRounds) {
                const nextMatch = tournament.matches.find(m => 
                    m.bracket === 'losers' && 
                    m.round === nextRound && 
                    (!m.team1 || !m.team2)
                );
                
                if (nextMatch) {
                    if (!nextMatch.team1) {
                        nextMatch.team1 = winner;
                    } else if (!nextMatch.team2) {
                        nextMatch.team2 = winner;
                        nextMatch.status = 'ready';
                    }
                }
            }
        }
        
        function sendToLosersBracket(loser, winnersRound) {
            // Правильная логика Double Elimination:
            // W1 проигравшие -> L1
            // W2 проигравшие -> L2 (играют с победителями L1)
            // W3 проигравшие -> L4 (играют с победителями L3)
            // W4 проигравшие -> L6 (играют с победителями L5)
            
            let targetRound;
            if (winnersRound === 1) {
                targetRound = 1;
            } else {
                // Проигравшие из Wn идут в L(2n-2)
                targetRound = (winnersRound - 1) * 2;
            }
            
            // Находим или создаем матч в нужном раунде
            let targetMatch = tournament.matches.find(m => 
                m.bracket === 'losers' && 
                m.round === targetRound && 
                (!m.team1 || !m.team2)
            );
            
            if (!targetMatch) {
                targetMatch = {
                    id: tournament.currentMatchId++,
                    team1: null,
                    team2: null,
                    winner: null,
                    loser: null,
                    bracket: 'losers',
                    round: targetRound,
                    status: 'waiting',
                    position: 0
                };
                tournament.matches.push(targetMatch);
            }
            
            // Добавляем команду в матч
            if (!targetMatch.team1) {
                targetMatch.team1 = loser;
            } else if (!targetMatch.team2) {
                targetMatch.team2 = loser;
                targetMatch.status = 'ready';
            }
            
            // Если это не первый раунд, нужно добавить соперника из предыдущего раунда Losers
            if (winnersRound > 1) {
                addWinnerFromPreviousLosersRound(targetMatch, targetRound);
            }
        }
        
        function findOrCreateLoserMatch(round, team) {
            // Ищем существующий матч
            let match = tournament.matches.find(m => 
                m.bracket === 'losers' && 
                m.round === round && 
                (!m.team1 || !m.team2)
            );
            
            if (!match) {
                // Создаем новый матч
                match = {
                    id: tournament.currentMatchId++,
                    team1: team,
                    team2: null,
                    winner: null,
                    loser: null,
                    bracket: 'losers',
                    round: round,
                    status: 'waiting',
                    position: 0
                };
                tournament.matches.push(match);
            } else {
                // Добавляем команду в существующий матч
                if (!match.team1) {
                    match.team1 = team;
                } else if (!match.team2) {
                    match.team2 = team;
                    match.status = 'ready';
                }
            }
            
            return match;
        }
        
        function addWinnerFromPreviousLosersRound(match, currentRound) {
            // Находим победителя из предыдущего раунда Losers Bracket
            const prevRound = currentRound - 1;
            const prevWinner = tournament.matches.find(m => 
                m.bracket === 'losers' && 
                m.round === prevRound && 
                m.winner
            );
            
            if (prevWinner && prevWinner.winner) {
                if (!match.team1) {
                    match.team1 = prevWinner.winner;
                } else if (!match.team2) {
                    match.team2 = prevWinner.winner;
                    match.status = 'ready';
                }
            }
        }
        
        function getNextLosersBracketRound(currentRound) {
            // В Losers Bracket раунды идут последовательно
            // Но нужно учитывать структуру Double Elimination
            const maxLosersRounds = Math.ceil(Math.log2(tournament.teams.length)) * 2 - 1;
            
            if (currentRound < maxLosersRounds) {
                return currentRound + 1;
            }
            
            return null; // Финал Losers Bracket
        }
        
        function getWinnersRoundForLosersRound(losersRound) {
            // Определяем, из какого раунда Winners Bracket приходят проигравшие
            if (losersRound % 2 === 1 && losersRound > 1) {
                // Нечетные раунды L3, L5, L7... получают проигравших из W2, W3, W4...
                return Math.ceil(losersRound / 2) + 1;
            }
            return null;
        }
        
        function checkTournamentComplete() {
            const activePlayers = tournament.teams.filter(t => !t.eliminated);
            
            if (activePlayers.length === 1) {
                tournament.champion = activePlayers[0];
                tournament.isComplete = true;
                updateStatus(`🏆 Турнир завершен! Чемпион: ${tournament.champion.name}`);
            }
        }
        
        function simulateMatch() {
            const readyMatches = tournament.matches.filter(m => m.status === 'ready' && !m.winner);
            
            if (readyMatches.length === 0) {
                updateStatus('Нет готовых матчей для симуляции');
                return;
            }
            
            const match = readyMatches[0];
            if (match.team1 && match.team2) {
                const winnerId = Math.random() < 0.5 ? match.team1.id : match.team2.id;
                setWinner(match.id, winnerId);
            }
        }
        
        function resetTournament() {
            tournament = {
                teams: [],
                matches: [],
                currentMatchId: 1,
                isComplete: false,
                champion: null
            };
            
            document.getElementById('team-count').textContent = '0';
            document.getElementById('bracket-container').innerHTML = 
                '<p style="text-align: center; color: #666; font-style: italic;">Выберите количество команд для начала турнира</p>';
            updateStatus('Готов к созданию турнира');
        }
        
        function hideControls() {
            const controls = document.querySelector('.controls');
            const status = document.getElementById('status');
            
            if (controls.style.display === 'none') {
                controls.style.display = 'block';
                status.style.display = 'block';
            } else {
                controls.style.display = 'none';
                status.style.display = 'none';
            }
        }
        
        // Горячие клавиши
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        createTournament(4);
                        break;
                    case '2':
                        e.preventDefault();
                        createTournament(8);
                        break;
                    case '3':
                        e.preventDefault();
                        createTournament(16);
                        break;
                    case 'r':
                        e.preventDefault();
                        simulateMatch();
                        break;
                    case 'h':
                        e.preventDefault();
                        hideControls();
                        break;
                    case 'Backspace':
                        e.preventDefault();
                        resetTournament();
                        break;
                }
            }
        });
    </script>
</body>
</html>