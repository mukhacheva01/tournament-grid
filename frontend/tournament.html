<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞</title>
<style>
 body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#f7f7f7}
 h1{margin-top:0}
 #teams input[type=text]{margin:2px 0}
 table.setka{border-collapse:collapse;font-size:14px}
 table.setka td{padding:3px 5px;border:1px solid #ccc;min-width:80px;text-align:center}
 .vinlus0{background:#dff0d8}
 .vinlus1{background:#f2dede}
 .lw{font-size:10px;color:#888}
 .si{font-weight:bold}

 body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
        }
        .main-header {
            color: white;
            text-align: center;
            padding: 40px 20px;
        }
        .main-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
  .main-header p {
            margin: 10px 0 30px 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        .nav-btn.active {
            background: white;
            color: #667eea;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        .teams-input {
            margin: 20px 0;
        }
        .teams-input label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #4a5568;
            font-size: 16px;
        }
</style>
</head>
<body>
   <div class="container">
        <div class="main-header">
            <h1>üèÜ –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞</h1>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç—É—Ä–Ω–∏—Ä–Ω—ã–º–∏ —Å–µ—Ç–∫–∞–º–∏</p>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn">
                    üèÜ –¢—É—Ä–Ω–∏—Ä—ã
                </a>
                <a href="tournament.html" class="nav-btn active">
                    üèõÔ∏è –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞
                </a>
            </div>
        </div>

         <div class="content">
            <div class="section">
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏</h2>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥: <input type="number" id="teamCount" value="7" min="2" max="64"></label>
            <button id="startBtn">–°–æ–∑–¥–∞—Ç—å —Å–µ—Ç–∫—É</button>

<div id="teams" style="margin:15px 0"></div>
<div id="tabl"></div>
<div id="tablo"></div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ rasp -->
<div class="section" id="rasp-settings" style="display:none; margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>
    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
        <label>–í—Ä–µ–º—è: <input type="number" id="tbeginh" value="10" min="0" max="23" style="width:40px;">:<input type="number" id="tbeginmin" value="0" min="0" max="59" style="width:40px;"></label>
        <label>–î–∞—Ç–∞: <input type="number" id="tbegind" value="26" min="1" max="31" style="width:40px;">/<input type="number" id="tbeginmon" value="8" min="1" max="12" style="width:40px;">/<input type="number" id="tbeginy" value="25" min="0" max="99" style="width:40px;"></label>
        <label>–ö–æ—Ä—Ç: <input type="number" id="hcountcourt" value="2" min="1" max="10" style="width:50px;"></label>
        <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª (–º–∏–Ω): <input type="number" id="htimeset" value="30" min="10" max="120" style="width:60px;"></label>
        <button onclick="generateRaspTable()" style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
    </div>
</div>

<div id="trasp"></div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –º–∞—Ç—á–µ–π -->

<iframe name="transport" id="transport" style="display:none"></iframe>
<iframe name="transp1" id="transp1" style="display:none"></iframe>
            </div>
        </div>

    



<!-- –§–æ—Ä–º–∞, —Ç—Ä–µ–±—É–µ–º–∞—è main.js –¥–ª—è –æ—Ç–ø—Ä–∞–≤–æ–∫ -->
<form name="comands" target="transport"><input type="hidden" name="hid"></form>

<script src="main.js"></script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ main.js
var adm = true; // –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –¥–µ–π—Å—Ç–≤–∏–π
var turnir_id = 1;
var org_id = 0; // –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ ReferenceError –≤ main.js
var org_idt = 1;
var s = 0;              // —Ç–µ–∫—É—â–∏–π —Ä–∞—É–Ω–¥ (–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –≤ def_s)
var comandy = [];
var gamid_oldid = [];   // –≤—Å–ø–æ–º. –º–∞—Å—Å–∏–≤, –Ω—É–∂–µ–Ω –≤ write_table
var tablores = {};      // –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–∞–±–ª–æ
var arasp = [];         // —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

// –ü–æ–ª—É—á–µ–Ω–∏–µ ID —Ç—É—Ä–Ω–∏—Ä–∞ –∏–∑ URL
function getTournamentIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞ —Å –±—ç–∫–µ–Ω–¥–∞
async function loadTournamentData() {
    const tournamentId = getTournamentIdFromUrl();
    if (!tournamentId) {
        alert('ID —Ç—É—Ä–Ω–∏—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL');
        return;
    }
    
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä–∞
        const tournamentResponse = await fetch(`/api/tournaments/${tournamentId}`);
        const tournament = await tournamentResponse.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.querySelector('.main-header h1').innerHTML = `üèÜ ${tournament.name}`;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–∞–Ω–¥—ã —Ç—É—Ä–Ω–∏—Ä–∞
        const teamsResponse = await fetch(`/api/tournaments/${tournamentId}/teams`);
        const teams = await teamsResponse.json();
        
        if (teams.length > 0) {
            comandy = teams.map(team => team.name);
            document.getElementById('teamCount').value = comandy.length;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞
            const stateResponse = await fetch(`/api/tournaments/${tournamentId}/state`);
            if (stateResponse.ok) {
                const state = await stateResponse.json();
                if (state.bracket) {
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–∏
                    restoreTournamentState(state);
                } else {
                    // –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Ç–∫—É
                    initializeTournament();
                }
            } else {
                initializeTournament();
            }
        } else {
            // –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            alert('–í —Ç—É—Ä–Ω–∏—Ä–µ –Ω–µ—Ç –∫–æ–º–∞–Ω–¥. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ç–∫–∏.');
        }
        
        turnir_id = tournamentId;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
function initializeTournament() {
    if (comandy.length >= 2) {
        write_teams();
        def_s();
        write_table(s);
        document.getElementById('rasp-settings').style.display = 'block';
    }
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
function restoreTournamentState(state) {
    try {
        if (state.bracket) {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            if (state.bracket.setka) window.setka = state.bracket.setka;
            if (state.bracket.s !== undefined) s = state.bracket.s;
            if (state.bracket.arasp) arasp = state.bracket.arasp;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            write_teams();
            if (s > 0) {
                write_table(s);
                document.getElementById('rasp-settings').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
        initializeTournament();
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
async function saveTournamentState() {
    const tournamentId = getTournamentIdFromUrl();
    if (!tournamentId) return;
    
    try {
        const state = {
            bracket: {
                setka: window.setka || {},
                s: s,
                arasp: arasp,
                comandy: comandy
            }
        };
        
        await fetch(`/api/tournaments/${tournamentId}/state`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(state)
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadTournamentData();
});

function generateTeams(cnt){
  return Array.from({length:cnt}, (_,i)=>`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`);
}

document.getElementById('startBtn').addEventListener('click', async ()=>{
  const cnt = Math.max(2, Math.min(64, Number(document.getElementById('teamCount').value||7)));
  const tournamentId = getTournamentIdFromUrl();
  
  if (tournamentId) {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    try {
      // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
      await fetch(`/api/tournaments/${tournamentId}/teams`, {
        method: 'DELETE'
      });
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
      const teams = Array.from({length:cnt}, (_,i)=>`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`);
      for (let i = 0; i < teams.length; i++) {
        await fetch(`/api/tournaments/${tournamentId}/teams`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name: teams[i] })
        });
      }
      
      comandy = teams;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥:', error);
      comandy = generateTeams(cnt);
    }
  } else {
    comandy = generateTeams(cnt);
  }
  
  write_teams();      // –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫
  def_s();            // —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏
  write_table(s);     // –≤—ã–≤–µ—Å—Ç–∏ —Å—Ö–µ–º—É
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ç–∫–∏
  document.getElementById('rasp-settings').style.display = 'block';
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  setTimeout(() => {
    saveTournamentState();
  }, 100);
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ rasp
function generateRaspTable() {
  if (!window.setka || !window.s || comandy.length < 2) {
    alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç—É—Ä–Ω–∏—Ä–Ω—É—é —Å–µ—Ç–∫—É!');
    return;
  }
  
  // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é rasp –∏–∑ main.js
  if (typeof rasp === 'function') {
    rasp(true); // true –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–∞—á–∞—Ç—å –Ω–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
  } else {
    alert('–§—É–Ω–∫—Ü–∏—è rasp –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ main.js');
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function loadTeams() {
            const textarea = document.getElementById('teams-textarea');
            const teams = textarea.value.split('\n').map(team => team.trim()).filter(team => team !== '');
            comandy = teams;
            displayTeams();
        }
        
        function displayTeams() {
            const display = document.getElementById('teams-display');
            display.innerHTML = '';
            comandy.forEach((team, index) => {
                const div = document.createElement('div');
                div.className = 'team-item';
                div.textContent = `${index + 1}. ${team}`;
                display.appendChild(div);
            });
        }
        
        function shuffleTeams() {
            if (comandy.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã!');
                return;
            }
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –∫–æ–º–∞–Ω–¥
            for (let i = comandy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [comandy[i], comandy[j]] = [comandy[j], comandy[i]];
            }
            displayTeams();
        }
        

        

         
         function getRoundName(round, totalRounds) {
            if (round === totalRounds) return '–§–∏–Ω–∞–ª';
            if (round === totalRounds - 1) return '–ü–æ–ª—É—Ñ–∏–Ω–∞–ª';
            if (round === totalRounds - 2) return '–ß–µ—Ç–≤–µ—Ä—Ç—å—Ñ–∏–Ω–∞–ª';
            return `${round} —Ä–∞—É–Ω–¥`;
        }
        
        async function saveSchedule() {
            await saveTournamentState();
            alert('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        }
        
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ main.js –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const originalWriteTable = window.write_table;
        window.write_table = function(...args) {
            if (originalWriteTable) {
                const result = originalWriteTable.apply(this, args);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
                setTimeout(() => saveTournamentState(), 500);
                return result;
            }
        };
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–µ
        const originalSetResult = window.set_result;
        if (originalSetResult) {
            window.set_result = function(...args) {
                const result = originalSetResult.apply(this, args);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                setTimeout(() => saveTournamentState(), 500);
                return result;
            };
        }
</script>
</body>
</html>